<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JELILIAN 功能测试</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .loading { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>JELILIAN 功能测试面板</h1>
    
    <div class="test-section">
        <h3>1. 服务器连接测试</h3>
        <button onclick="testServerConnection()">测试服务器连接</button>
        <div id="serverResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. API提供商测试</h3>
        <button onclick="testProviders()">获取支持的AI服务商</button>
        <div id="providersResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. AI对话测试</h3>
        <div>
            <label>选择AI服务商：</label>
            <select id="providerSelect">
                <option value="qwen">阿里千问</option>
                <option value="openai">OpenAI</option>
            </select>
        </div>
        <div>
            <label>API密钥：</label>
            <input type="password" id="apiKeyInput" placeholder="输入API密钥" style="width: 300px; padding: 5px;">
        </div>
        <textarea id="messageInput" placeholder="输入测试消息...">你好，请简单介绍一下你自己</textarea>
        <button onclick="testChat()">发送测试消息</button>
        <div id="chatResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. 界面功能测试</h3>
        <button onclick="testInterface()">测试主界面功能</button>
        <div id="interfaceResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        
        async function testServerConnection() {
            const resultDiv = document.getElementById('serverResult');
            resultDiv.innerHTML = '正在测试服务器连接...';
            resultDiv.className = 'result loading';
            
            try {
                const response = await fetch(API_BASE + '/providers');
                if (response.ok) {
                    resultDiv.innerHTML = '✅ 服务器连接成功！';
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = '❌ 服务器响应异常: ' + response.status;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = '❌ 服务器连接失败: ' + error.message;
                resultDiv.className = 'result error';
            }
        }
        
        async function testProviders() {
            const resultDiv = document.getElementById('providersResult');
            resultDiv.innerHTML = '正在获取AI服务商列表...';
            resultDiv.className = 'result loading';
            
            try {
                const response = await fetch(API_BASE + '/providers');
                const data = await response.json();
                
                if (data.success) {
                    const providersList = data.providers.map(p => 
                        `• ${p.name} (${p.id}): ${p.description}`
                    ).join('<br>');
                    resultDiv.innerHTML = '✅ 支持的AI服务商:<br>' + providersList;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = '❌ 获取失败: ' + data.error;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = '❌ 请求失败: ' + error.message;
                resultDiv.className = 'result error';
            }
        }
        
        async function testChat() {
            const resultDiv = document.getElementById('chatResult');
            const provider = document.getElementById('providerSelect').value;
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const message = document.getElementById('messageInput').value.trim();
            
            if (!apiKey) {
                resultDiv.innerHTML = '❌ 请输入API密钥';
                resultDiv.className = 'result error';
                return;
            }
            
            if (!message) {
                resultDiv.innerHTML = '❌ 请输入测试消息';
                resultDiv.className = 'result error';
                return;
            }
            
            resultDiv.innerHTML = '正在测试AI对话...';
            resultDiv.className = 'result loading';
            
            try {
                const response = await fetch(API_BASE + '/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        provider: provider,
                        apiKey: apiKey,
                        options: { maxTokens: 100 }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `✅ AI对话测试成功！<br>
                        <strong>服务商:</strong> ${data.provider}<br>
                        <strong>响应时间:</strong> ${data.responseTime}ms<br>
                        <strong>回复内容:</strong><br>
                        <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 4px;">
                            ${data.text}
                        </div>`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `❌ AI对话测试失败:<br>
                        <strong>错误:</strong> ${data.error}<br>
                        <strong>服务商:</strong> ${data.provider || 'unknown'}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = '❌ 请求失败: ' + error.message;
                resultDiv.className = 'result error';
            }
        }
        
        function testInterface() {
            const resultDiv = document.getElementById('interfaceResult');
            
            // 检查主要界面元素
            const checks = [
                { name: '主页面访问', test: () => fetch('http://localhost:3000/').then(r => r.ok) },
                { name: 'Manus风格界面', test: () => fetch('http://localhost:3000/manus-clone.html').then(r => r.ok) },
                { name: '公共客户端', test: () => fetch('http://localhost:3000/public-client.html').then(r => r.ok) }
            ];
            
            resultDiv.innerHTML = '正在测试界面功能...';
            resultDiv.className = 'result loading';
            
            Promise.all(checks.map(async check => {
                try {
                    const result = await check.test();
                    return { name: check.name, success: result };
                } catch (error) {
                    return { name: check.name, success: false, error: error.message };
                }
            })).then(results => {
                const resultText = results.map(r => 
                    r.success ? `✅ ${r.name}` : `❌ ${r.name}: ${r.error || '失败'}`
                ).join('<br>');
                
                const allSuccess = results.every(r => r.success);
                resultDiv.innerHTML = resultText;
                resultDiv.className = allSuccess ? 'result success' : 'result error';
            });
        }
        
        // 页面加载时自动测试服务器连接
        window.onload = function() {
            testServerConnection();
        };
    </script>
</body>
</html>